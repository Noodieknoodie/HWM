-- =====================================================
-- AI-Enhanced Database Schema
-- Generated: 2025-07-07 22:07:49
-- Purpose: Provide comprehensive schema + data insights for AI coding assistants
-- =====================================================

-- === Table: clients === --
-- Schema: dbo
-- Total Rows: 29

CREATE TABLE [dbo].[clients] (
    [client_id] int IDENTITY(1,1) NOT NULL,
    [display_name] nvarchar(255) NOT NULL,
    [full_name] nvarchar(255),
    [ima_signed_date] date,
    CONSTRAINT [PK_clients] PRIMARY KEY (client_id)
);

-- Column Statistics:
--   client_id: 29 distinct values, 0 nulls (0.0%)
--   display_name: 29 distinct values, 0 nulls (0.0%)
--   full_name: 29 distinct values, 0 nulls (0.0%)
--   ima_signed_date: 18 distinct values, 9 nulls (31.0%)

** -- SAMPLE DATA -- **
-- client_id            | display_name         | full_name            | ima_signed_date     
-- -----------------------------------------------------------------------------------------
-- 1                    | AirSea America       | THE TRUSTEES OF AIRS | 2020-07-31          
-- 2                    | Bumgardner Architect | THE BUMGARDNER ARCHI | 2020-08-02          
-- 3                    | Amplero              | AMPLERO INC 401K     | 2019-03-15          
-- 4                    | Auction Edge         | AUCTION EDGE Inc 401 | 2019-03-07          
-- 5                    | BDR Interactive      | BUSINESS DEVELOPMENT | 2021-02-23          
-- 6                    | Bellmont Cabinets    | BELLMONT CABINETS    | NULL                
-- 7                    | Corina Bakery        | CORINA BAKERY        | 2020-07-28          
-- 8                    | Dakota Creek         | DAKOTA CREEK INDUSTR | NULL                
-- 9                    | CG Engineering       | CG ENGINEERING PLLC  | 2020-07-28          
-- 10                   | Fast Water Heater    | FAST WATER HEATER CO | 2019-10-14          

-- === Table: contacts === --
-- Schema: dbo
-- Total Rows: 68

CREATE TABLE [dbo].[contacts] (
    [contact_id] int IDENTITY(1,1) NOT NULL,
    [client_id] int NOT NULL,
    [contact_type] nvarchar(50) NOT NULL,
    [contact_name] nvarchar(255),
    [phone] nvarchar(50),
    [email] nvarchar(255),
    [fax] nvarchar(50),
    [physical_address] nvarchar(500),
    [mailing_address] nvarchar(500),
    CONSTRAINT [PK_contacts] PRIMARY KEY (contact_id)
);

-- Foreign Keys:
-- FK: FK_contacts_clients (client_id) -> clients (client_id)

-- Column Statistics:
--   contact_id: 68 distinct values, 0 nulls (0.0%)
--   client_id: 29 distinct values, 0 nulls (0.0%)
--   contact_type: 3 distinct values, 0 nulls (0.0%)
--   contact_name: 57 distinct values, 5 nulls (7.4%)
--   phone: 30 distinct values, 29 nulls (42.6%)
--   email: 46 distinct values, 17 nulls (25.0%)
--   fax: 2 distinct values, 66 nulls (97.1%)
--   physical_address: 28 distinct values, 36 nulls (52.9%)
--   mailing_address: 17 distinct values, 51 nulls (75.0%)

** -- SAMPLE DATA -- **
-- contact_id           | client_id            | contact_type         | contact_name         | phone                | email                | fax                  | physical_address     | mailing_address     
-- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | 1                    | Primary              | Donald Jay           | 253-395-9551         | djay@asamerica.com   | NULL                 | 3500 West Vally HWY, | 3500 West Vally HWY,
-- 2                    | 2                    | Primary              | Mark Simpson         | 206-223-1361         | marks@bumgardner.biz | NULL                 | 2111 Third Ave, Seat | 2111 Third Ave, Seat
-- 3                    | 3                    | Primary              | Doug Gelfand         | 206-816-3700         | dgelfand@amplero.com | NULL                 | 1218 3rd Ave #900, S | NULL                
-- ...
-- 66                   | 26                   | Provider             | Austin Del Prado     | 800-333-0963         | delprau@jhancock.com | NULL                 | 601 Congress St, Bos | NULL                
-- 67                   | 27                   | Provider             | Brett Lundgren       | 866-421-2137         | Brett.Lundgren@capgr | NULL                 | NULL                 | NULL                
-- 68                   | 29                   | Provider             | Maria Viala-Wood     | NULL                 | maria.vialawood@tran | NULL                 | NULL                 | NULL                

-- === Table: contracts === --
-- Schema: dbo
-- Total Rows: 29

CREATE TABLE [dbo].[contracts] (
    [contract_id] int IDENTITY(1,1) NOT NULL,
    [client_id] int NOT NULL,
    [contract_number] nvarchar(100),
    [provider_name] nvarchar(255),
    [contract_start_date] date,
    [fee_type] nvarchar(50),
    [percent_rate] float,
    [flat_rate] float,
    [payment_schedule] nvarchar(50),
    [num_people] int,
    [notes] nvarchar(MAX),
    CONSTRAINT [PK_contracts] PRIMARY KEY (contract_id)
);

-- Foreign Keys:
-- FK: FK_contracts_clients (client_id) -> clients (client_id)

-- Column Statistics:
--   contract_id: 29 distinct values, 0 nulls (0.0%)
--   client_id: 29 distinct values, 0 nulls (0.0%)
--   contract_number: 20 distinct values, 9 nulls (31.0%)
--   provider_name: 12 distinct values, 0 nulls (0.0%)
--   contract_start_date: 3 distinct values, 26 nulls (89.7%)
--   fee_type: 2 distinct values, 0 nulls (0.0%)
--   percent_rate: 13 distinct values, 12 nulls (41.4%)
--   flat_rate: 10 distinct values, 17 nulls (58.6%)
--   payment_schedule: 2 distinct values, 0 nulls (0.0%)
--   num_people: 19 distinct values, 4 nulls (13.8%)
--   notes: 1 distinct values, 28 nulls (96.6%)

** -- SAMPLE DATA -- **
-- contract_id          | client_id            | contract_number      | provider_name        | contract_start_date  | fee_type             | percent_rate         | flat_rate            | payment_schedule     | num_people           | notes               
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | 1                    | 134565               | John Hancock         | 2018-03-22           | percentage           | 0.0007               | NULL                 | monthly              | 18                   | Phone: 800-333-0963 
-- 2                    | 2                    | NULL                 | Voya                 | 2019-04-19           | percentage           | 0.000416             | NULL                 | monthly              | 35                   | NULL                
-- 3                    | 3                    | 551296               | Voya                 | NULL                 | flat                 | NULL                 | 666.66               | monthly              | NULL                 | NULL                
-- 5                    | 5                    | 231393               | Ascensus Trust Compa | 2019-05-01           | flat                 | NULL                 | 3000.0               | quarterly            | 93                   | NULL                
-- 6                    | 6                    | 29366                | John Hancock         | NULL                 | percentage           | 0.000125             | NULL                 | monthly              | 289                  | NULL                
-- 8                    | 8                    | 273504               | Ascensus             | NULL                 | percentage           | 0.003446             | NULL                 | quarterly            | 177                  | NULL                
-- 9                    | 9                    | 134019               | Direct from CG Engin | NULL                 | flat                 | NULL                 | 2500.0               | quarterly            | 42                   | NULL                
-- 10                   | 10                   | NULL                 | Empower              | NULL                 | percentage           | 0.000667             | NULL                 | monthly              | 208                  | NULL                
-- 11                   | 11                   | 147266               | John Hancock         | NULL                 | percentage           | 0.000208             | NULL                 | monthly              | 531                  | NULL                
-- 12                   | 12                   | 222908               | Ascensus Trust Compa | NULL                 | flat                 | NULL                 | 2500.0               | quarterly            | 80                   | NULL                

-- === Table: payment_periods === --
-- Schema: dbo
-- Total Rows: 192

CREATE TABLE [dbo].[payment_periods] (
    [period_type] nvarchar(10) NOT NULL,
    [year] int NOT NULL,
    [period] int NOT NULL,
    [period_name] nvarchar(50) NOT NULL,
    [start_date] date NOT NULL,
    [end_date] date NOT NULL,
    [is_current] bit NOT NULL DEFAULT ((0)),
    CONSTRAINT [PK__payment___EA8CC9CD5742350A] PRIMARY KEY (period_type, year, period)
);

-- Column Statistics:
--   period_type: 2 distinct values, 0 nulls (0.0%)
--   year: 12 distinct values, 0 nulls (0.0%)
--   period: 12 distinct values, 0 nulls (0.0%)
--   period_name: 192 distinct values, 0 nulls (0.0%)
--   start_date: 144 distinct values, 0 nulls (0.0%)
--   end_date: 144 distinct values, 0 nulls (0.0%)
--   is_current: 2 distinct values, 0 nulls (0.0%)

** -- SAMPLE DATA -- **
-- period_type          | year                 | period               | period_name          | start_date           | end_date             | is_current          
-- --------------------------------------------------------------------------------------------------------------------------------------------------------------
-- monthly              | 2019                 | 1                    | January 2019         | 2019-01-01           | 2019-01-31           | False               
-- monthly              | 2019                 | 2                    | February 2019        | 2019-02-01           | 2019-02-28           | False               
-- monthly              | 2019                 | 3                    | March 2019           | 2019-03-01           | 2019-03-31           | False               
-- ...
-- monthly              | 2027                 | 1                    | January 2027         | 2027-01-01           | 2027-01-31           | False               
-- monthly              | 2027                 | 2                    | February 2027        | 2027-02-01           | 2027-02-28           | False               
-- monthly              | 2027                 | 3                    | March 2027           | 2027-03-01           | 2027-03-31           | False               

-- === Table: payments === --
-- Schema: dbo
-- Total Rows: 888

CREATE TABLE [dbo].[payments] (
    [payment_id] int IDENTITY(1,1) NOT NULL,
    [contract_id] int NOT NULL,
    [client_id] int NOT NULL,
    [received_date] date,
    [total_assets] float,
    [expected_fee] float,
    [actual_fee] float,
    [method] nvarchar(50),
    [notes] nvarchar(MAX),
    [applied_period_type] nvarchar(10),
    [applied_period] int,
    [applied_year] int,
    CONSTRAINT [PK_payments] PRIMARY KEY (payment_id)
);

-- Foreign Keys:
-- FK: FK_payments_clients (client_id) -> clients (client_id)
-- FK: FK_payments_contracts (contract_id) -> contracts (contract_id)

-- Column Statistics:
--   payment_id: 888 distinct values, 0 nulls (0.0%)
--   contract_id: 29 distinct values, 0 nulls (0.0%)
--   client_id: 29 distinct values, 0 nulls (0.0%)
--   received_date: 347 distinct values, 0 nulls (0.0%)
--   total_assets: 450 distinct values, 433 nulls (48.8%)
--   expected_fee: 441 distinct values, 209 nulls (23.5%)
--   actual_fee: 648 distinct values, 0 nulls (0.0%)
--   method: 4 distinct values, 214 nulls (24.1%)
--   notes: 101 distinct values, 727 nulls (81.9%)
--   applied_period_type: 2 distinct values, 0 nulls (0.0%)
--   applied_period: 12 distinct values, 0 nulls (0.0%)
--   applied_year: 7 distinct values, 0 nulls (0.0%)

** -- SAMPLE DATA -- **
-- payment_id           | contract_id          | client_id            | received_date        | total_assets         | expected_fee         | actual_fee           | method               | notes                | applied_period_type  | applied_period       | applied_year        
-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | 1                    | 1                    | 2019-05-03           | 824305.0             | 542.01               | 547.51               | Auto - Check         | waiting on how John  | monthly              | 4                    | 2019                
-- 2                    | 1                    | 1                    | 2019-06-07           | 805477.0             | 547.28               | 535.03               | Auto - Check         | NULL                 | monthly              | 5                    | 2019                
-- 3                    | 1                    | 1                    | 2019-07-05           | 839288.0             | 551.86               | 557.54               | Auto - Check         | NULL                 | monthly              | 6                    | 2019                
-- ...
-- 103                  | 2                    | 2                    | 2022-05-22           | NULL                 | NULL                 | 1452.09              | Auto - ACH           | NULL                 | monthly              | 4                    | 2022                
-- 104                  | 2                    | 2                    | 2022-06-17           | NULL                 | NULL                 | 1459.3               | Auto - ACH           | NULL                 | monthly              | 5                    | 2022                
-- 105                  | 2                    | 2                    | 2022-07-15           | NULL                 | NULL                 | 1361.45              | Auto - ACH           | NULL                 | monthly              | 6                    | 2022                
-- ...
-- 221                  | 5                    | 5                    | 2020-10-13           | NULL                 | 3750.0               | 3750.0               | Auto - Check         | NULL                 | quarterly            | 3                    | 2020                
-- 222                  | 5                    | 5                    | 2021-01-14           | NULL                 | 3750.0               | 3750.0               | Auto - Check         | NULL                 | quarterly            | 4                    | 2020                
-- 223                  | 5                    | 5                    | 2021-04-19           | NULL                 | 3000.0               | 3000.0               | Auto - Check         | NULL                 | quarterly            | 1                    | 2021                
-- ...
-- 328                  | 9                    | 9                    | 2023-01-31           | NULL                 | 2500.0               | 2500.0               | Invoice - Check      | One check rcvd 1.31. | quarterly            | 4                    | 2022                
-- 329                  | 9                    | 9                    | 2023-05-22           | NULL                 | 2500.0               | 2500.0               | Invoice - Check      | One check rcvd 5.22. | quarterly            | 1                    | 2023                
-- 330                  | 9                    | 9                    | 2023-08-28           | NULL                 | 2500.0               | 2500.0               | Invoice - Check      | one check rcvd 8.28. | quarterly            | 2                    | 2023                
-- ...
-- 428                  | 12                   | 12                   | 2021-04-19           | NULL                 | 2500.0               | 2250.0               | Auto - Check         | NULL                 | quarterly            | 1                    | 2021                
-- 429                  | 12                   | 12                   | 2021-07-16           | NULL                 | 2250.0               | 2250.0               | Auto - Check         | NULL                 | quarterly            | 2                    | 2021                
-- 430                  | 12                   | 12                   | 2021-10-18           | NULL                 | 2250.0               | 2250.0               | Auto - Check         | NULL                 | quarterly            | 3                    | 2021                
-- ...
-- 528                  | 15                   | 15                   | 2022-11-15           | NULL                 | NULL                 | 65.36                | Auto - Check         | NULL                 | monthly              | 10                   | 2022                
-- 529                  | 15                   | 15                   | 2022-12-13           | 166997.0             | 69.637749            | 69.58                | Auto - Check         | NULL                 | monthly              | 11                   | 2022                
-- 530                  | 15                   | 15                   | 2023-01-12           | 160289.0             | 66.840513            | 66.79                | Auto - Check         | NULL                 | monthly              | 12                   | 2022                
-- ...
-- 636                  | 21                   | 21                   | 2021-09-14           | 115330.0             | 96.06989             | 95.66                | Auto - ACH           | NULL                 | monthly              | 8                    | 2021                
-- 637                  | 21                   | 21                   | 2021-10-15           | 110904.0             | 92.383032            | 92.0                 | Auto - ACH           | NULL                 | monthly              | 9                    | 2021                
-- 638                  | 21                   | 21                   | 2021-11-16           | 76777.0              | 63.955241            | 63.68                | Auto - ACH           | NULL                 | monthly              | 10                   | 2021                
-- ...
-- 736                  | 23                   | 23                   | 2021-02-16           | 1076744.0            | 449.002248           | 447.55               | NULL                 | test
                | monthly              | 1                    | 2021                
-- 737                  | 23                   | 23                   | 2021-03-15           | 1115961.0            | 465.355737           | 463.82               | NULL                 | NULL                 | monthly              | 2                    | 2021                
-- 738                  | 23                   | 23                   | 2021-04-12           | 1154953.0            | 481.615401           | 480.17               | NULL                 | NULL                 | monthly              | 3                    | 2021                
-- ...
-- 846                  | 34                   | 28                   | 2021-08-23           | 2303295.0            | 1536.297765          | 1535.53              | Auto - ACH           | NULL                 | monthly              | 7                    | 2021                
-- 847                  | 34                   | 28                   | 2021-09-20           | 2321847.0            | 1548.671949          | 1547.92              | Auto - ACH           | NULL                 | monthly              | 8                    | 2021                
-- 848                  | 34                   | 28                   | 2021-10-20           | 2340138.0            | 1560.872046          | 1560.11              | Auto - ACH           | NULL                 | monthly              | 9                    | 2021                

-- === View: client_metrics_view === --
-- Schema: dbo
-- Row Count: 29

-- Recreate client_metrics_view (removing quarterly_summaries reference)
CREATE VIEW client_metrics_view AS
WITH LastPayment AS (
    SELECT 
        client_id,
        received_date as last_payment_date,
        actual_fee as last_payment_amount,
        total_assets as last_recorded_assets,
        ROW_NUMBER() OVER (PARTITION BY client_id ORDER BY received_date DESC) as rn
    FROM payments
)
SELECT 
    c.client_id,
    lp.last_payment_date,
    lp.last_payment_amount,
    ytd.total_ytd_payments,
    NULL as avg_quarterly_payment, -- removed quarterly_summaries dependency
    lp.last_recorded_assets,
    GETDATE() as last_updated
FROM clients c
LEFT JOIN LastPayment lp ON c.client_id = lp.client_id AND lp.rn = 1
LEFT JOIN (
    SELECT client_id, SUM(actual_fee) as total_ytd_payments
    FROM payments 
    WHERE applied_year = YEAR(GETDATE())
    GROUP BY client_id
) ytd ON c.client_id = ytd.client_id;

** -- SAMPLE DATA -- **
-- client_id            | last_payment_date    | last_payment_amount  | total_ytd_payments   | avg_quarterly_paymen | last_recorded_assets | last_updated        
-- --------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | 2025-05-13           | 930.09               | 2786.4700000000003   | NULL                 | 1400234.25           | 2025-07-08 05:07:51.
-- 2                    | 2024-07-31           | 1906.77              | NULL                 | NULL                 | NULL                 | 2025-07-08 05:07:51.
-- 3                    | 2024-07-31           | 666.66               | NULL                 | NULL                 | NULL                 | 2025-07-08 05:07:51.
-- 4                    | 2025-04-28           | 13080.79             | 13080.79             | NULL                 | NULL                 | 2025-07-08 05:07:51.
-- 5                    | 2025-04-16           | 3000.0               | 3000.0               | NULL                 | NULL                 | 2025-07-08 05:07:51.
-- 6                    | 2025-05-13           | 1842.36              | 5570.2               | NULL                 | 14750011.93          | 2025-07-08 05:07:51.
-- 7                    | 2024-07-31           | 39.06                | NULL                 | NULL                 | NULL                 | 2025-07-08 05:07:51.
-- 8                    | 2025-04-16           | 5194.0               | 5194.0               | NULL                 | NULL                 | 2025-07-08 05:07:51.
-- 9                    | 2024-05-20           | 5000.0               | NULL                 | NULL                 | NULL                 | 2025-07-08 05:07:51.
-- 10                   | 2025-05-21           | 2059.46              | 10179.3              | NULL                 | 3089229.99           | 2025-07-08 05:07:51.

-- === View: client_payment_status === --
-- Schema: dbo
-- Row Count: 29

-- Recreate client_payment_status
CREATE VIEW client_payment_status AS
SELECT
    c.client_id,
    c.display_name,
    ct.payment_schedule,
    ct.fee_type,
    ct.flat_rate,
    ct.percent_rate,
    cmv.last_payment_date,
    cmv.last_payment_amount,
    latest.applied_period,
    latest.applied_year,
    latest.applied_period_type,
    CASE 
        WHEN ct.payment_schedule = 'monthly' THEN 
            CASE WHEN MONTH(GETDATE()) = 1 THEN 12 ELSE MONTH(GETDATE()) - 1 END
        WHEN ct.payment_schedule = 'quarterly' THEN 
            CASE WHEN DATEPART(QUARTER, GETDATE()) = 1 THEN 4 ELSE DATEPART(QUARTER, GETDATE()) - 1 END
    END AS current_period,
    CASE 
        WHEN MONTH(GETDATE()) = 1 AND ct.payment_schedule = 'monthly' THEN YEAR(GETDATE()) - 1
        WHEN DATEPART(QUARTER, GETDATE()) = 1 AND ct.payment_schedule = 'quarterly' THEN YEAR(GETDATE()) - 1
        ELSE YEAR(GETDATE())
    END AS current_year,
    cmv.last_recorded_assets,
    CASE
        WHEN ct.fee_type = 'flat' THEN ct.flat_rate
        WHEN ct.fee_type = 'percentage' AND cmv.last_recorded_assets IS NOT NULL THEN 
            ROUND(cmv.last_recorded_assets * (ct.percent_rate / 100.0), 2)
        ELSE NULL
    END AS expected_fee,
    CASE
        WHEN latest.applied_year IS NULL THEN 'Due'
        WHEN latest.applied_year < CASE 
            WHEN (MONTH(GETDATE()) = 1 AND ct.payment_schedule = 'monthly') OR 
                 (DATEPART(QUARTER, GETDATE()) = 1 AND ct.payment_schedule = 'quarterly')
            THEN YEAR(GETDATE()) - 1
            ELSE YEAR(GETDATE()) 
        END THEN 'Due'
        WHEN latest.applied_year = CASE 
            WHEN (MONTH(GETDATE()) = 1 AND ct.payment_schedule = 'monthly') OR 
                 (DATEPART(QUARTER, GETDATE()) = 1 AND ct.payment_schedule = 'quarterly')
            THEN YEAR(GETDATE()) - 1
            ELSE YEAR(GETDATE()) 
        END AND latest.applied_period < CASE
            WHEN ct.payment_schedule = 'monthly' THEN 
                CASE WHEN MONTH(GETDATE()) = 1 THEN 12 ELSE MONTH(GETDATE()) - 1 END
            WHEN ct.payment_schedule = 'quarterly' THEN 
                CASE WHEN DATEPART(QUARTER, GETDATE()) = 1 THEN 4 ELSE DATEPART(QUARTER, GETDATE()) - 1 END
        END THEN 'Due'
        ELSE 'Paid'
    END AS payment_status
FROM clients c
JOIN contracts ct ON c.client_id = ct.client_id
LEFT JOIN client_metrics_view cmv ON c.client_id = cmv.client_id
LEFT JOIN (
    SELECT * FROM (
        SELECT *, ROW_NUMBER() OVER (PARTITION BY client_id ORDER BY received_date DESC) as rn
        FROM payments
    ) AS numbered WHERE rn = 1
) latest ON c.client_id = latest.client_id;

** -- SAMPLE DATA -- **
-- client_id            | display_name         | payment_schedule     | fee_type             | flat_rate            | percent_rate         | last_payment_date    | last_payment_amount  | applied_period       | applied_year         | applied_period_type  | current_period       | current_year         | last_recorded_assets | expected_fee         | payment_status      
-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | AirSea America       | monthly              | percentage           | NULL                 | 0.0007               | 2025-05-13           | 930.09               | 4                    | 2025                 | monthly              | 6                    | 2025                 | 1400234.25           | 9.8                  | Due                 
-- 2                    | Bumgardner Architect | monthly              | percentage           | NULL                 | 0.000416             | 2024-07-31           | 1906.77              | 6                    | 2024                 | monthly              | 6                    | 2025                 | NULL                 | NULL                 | Due                 
-- 3                    | Amplero              | monthly              | flat                 | 666.66               | NULL                 | 2024-07-31           | 666.66               | 6                    | 2024                 | monthly              | 6                    | 2025                 | NULL                 | 666.66               | Due                 
-- 5                    | BDR Interactive      | quarterly            | flat                 | 3000.0               | NULL                 | 2025-04-16           | 3000.0               | 1                    | 2025                 | quarterly            | 2                    | 2025                 | NULL                 | 3000.0               | Due                 
-- 6                    | Bellmont Cabinets    | monthly              | percentage           | NULL                 | 0.000125             | 2025-05-13           | 1842.36              | 4                    | 2025                 | monthly              | 6                    | 2025                 | 14750011.93          | 18.44                | Due                 
-- 8                    | Dakota Creek         | quarterly            | percentage           | NULL                 | 0.003446             | 2025-04-16           | 5194.0               | 1                    | 2025                 | quarterly            | 2                    | 2025                 | NULL                 | NULL                 | Due                 
-- 9                    | CG Engineering       | quarterly            | flat                 | 2500.0               | NULL                 | 2024-05-20           | 5000.0               | 1                    | 2024                 | quarterly            | 2                    | 2025                 | NULL                 | 2500.0               | Due                 
-- 10                   | Fast Water Heater    | monthly              | percentage           | NULL                 | 0.000667             | 2025-05-21           | 2059.46              | 4                    | 2025                 | monthly              | 6                    | 2025                 | 3089229.99           | 20.61                | Due                 
-- 11                   | Floform              | monthly              | percentage           | NULL                 | 0.000208             | 2025-05-13           | 1947.11              | 4                    | 2025                 | monthly              | 6                    | 2025                 | 9357861.86           | 19.46                | Due                 
-- 12                   | Hansen Bros          | quarterly            | flat                 | 2500.0               | NULL                 | 2025-04-16           | 2250.0               | 1                    | 2025                 | quarterly            | 2                    | 2025                 | NULL                 | 2500.0               | Due                 

-- === View: clients_by_provider_view === --
-- Schema: dbo
-- Row Count: 29

-- Recreate clients_by_provider_view
CREATE VIEW clients_by_provider_view AS
SELECT 
    c.client_id,
    c.display_name,
    c.full_name,
    c.ima_signed_date,
    ct.contract_id,
    ct.provider_name,
    ct.fee_type,
    ct.percent_rate,
    ct.flat_rate,
    ct.payment_schedule,
    cm.last_payment_date,
    cm.last_payment_amount,
    cm.last_recorded_assets,
    cm.total_ytd_payments,
    cps.payment_status,
    CASE 
        WHEN cps.payment_status = 'Paid' THEN 'green'
        ELSE 'yellow'
    END AS compliance_status
FROM clients c
LEFT JOIN contracts ct ON c.client_id = ct.client_id
LEFT JOIN client_metrics_view cm ON c.client_id = cm.client_id
LEFT JOIN client_payment_status cps ON c.client_id = cps.client_id;

** -- SAMPLE DATA -- **
-- client_id            | display_name         | full_name            | ima_signed_date      | contract_id          | provider_name        | fee_type             | percent_rate         | flat_rate            | payment_schedule     | last_payment_date    | last_payment_amount  | last_recorded_assets | total_ytd_payments   | payment_status       | compliance_status   
-- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | AirSea America       | THE TRUSTEES OF AIRS | 2020-07-31           | 1                    | John Hancock         | percentage           | 0.0007               | NULL                 | monthly              | 2025-05-13           | 930.09               | 1400234.25           | 2786.4700000000003   | Due                  | yellow              
-- 2                    | Bumgardner Architect | THE BUMGARDNER ARCHI | 2020-08-02           | 2                    | Voya                 | percentage           | 0.000416             | NULL                 | monthly              | 2024-07-31           | 1906.77              | NULL                 | NULL                 | Due                  | yellow              
-- 3                    | Amplero              | AMPLERO INC 401K     | 2019-03-15           | 3                    | Voya                 | flat                 | NULL                 | 666.66               | monthly              | 2024-07-31           | 666.66               | NULL                 | NULL                 | Due                  | yellow              
-- 4                    | Auction Edge         | AUCTION EDGE Inc 401 | 2019-03-07           | 31                   | John Hancock         | percentage           | 0.00125              | NULL                 | quarterly            | 2025-04-28           | 13080.79             | NULL                 | 13080.79             | Due                  | yellow              
-- 5                    | BDR Interactive      | BUSINESS DEVELOPMENT | 2021-02-23           | 5                    | Ascensus Trust Compa | flat                 | NULL                 | 3000.0               | quarterly            | 2025-04-16           | 3000.0               | NULL                 | 3000.0               | Due                  | yellow              
-- 6                    | Bellmont Cabinets    | BELLMONT CABINETS    | NULL                 | 6                    | John Hancock         | percentage           | 0.000125             | NULL                 | monthly              | 2025-05-13           | 1842.36              | 14750011.93          | 5570.2               | Due                  | yellow              
-- 7                    | Corina Bakery        | CORINA BAKERY        | 2020-07-28           | 32                   | Voya                 | percentage           | 0.000417             | NULL                 | monthly              | 2024-07-31           | 39.06                | NULL                 | NULL                 | Due                  | yellow              
-- 8                    | Dakota Creek         | DAKOTA CREEK INDUSTR | NULL                 | 8                    | Ascensus             | percentage           | 0.003446             | NULL                 | quarterly            | 2025-04-16           | 5194.0               | NULL                 | 5194.0               | Due                  | yellow              
-- 9                    | CG Engineering       | CG ENGINEERING PLLC  | 2020-07-28           | 9                    | Direct from CG Engin | flat                 | NULL                 | 2500.0               | quarterly            | 2024-05-20           | 5000.0               | NULL                 | NULL                 | Due                  | yellow              
-- 10                   | Fast Water Heater    | FAST WATER HEATER CO | 2019-10-14           | 10                   | Empower              | percentage           | 0.000667             | NULL                 | monthly              | 2025-05-21           | 2059.46              | 3089229.99           | 10179.3              | Due                  | yellow              

-- === View: payment_variance_view === --
-- Schema: dbo
-- Row Count: 888

-- Recreate payment_variance_view
CREATE VIEW payment_variance_view AS
SELECT 
    p.*,
    p.actual_fee - p.expected_fee AS variance_amount,
    CASE 
        WHEN p.expected_fee = 0 OR p.expected_fee IS NULL THEN NULL
        ELSE ((p.actual_fee - p.expected_fee) / p.expected_fee) * 100
    END AS variance_percent,
    CASE 
        WHEN p.expected_fee IS NULL OR p.expected_fee = 0 THEN 'unknown'
        WHEN ABS(p.actual_fee - p.expected_fee) < 0.01 THEN 'exact'
        WHEN ABS(((p.actual_fee - p.expected_fee) / p.expected_fee) * 100) <= 5 THEN 'acceptable'
        WHEN ABS(((p.actual_fee - p.expected_fee) / p.expected_fee) * 100) <= 15 THEN 'warning'
        ELSE 'alert'
    END AS variance_status
FROM payments p;

** -- SAMPLE DATA -- **
-- payment_id           | contract_id          | client_id            | received_date        | total_assets         | expected_fee         | actual_fee           | method               | notes                | applied_period_type  | applied_period       | applied_year         | variance_amount      | variance_percent     | variance_status     
-- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | 1                    | 1                    | 2019-05-03           | 824305.0             | 542.01               | 547.51               | Auto - Check         | waiting on how John  | monthly              | 4                    | 2019                 | 5.5                  | 1.0147414254349552   | acceptable          
-- 2                    | 1                    | 1                    | 2019-06-07           | 805477.0             | 547.28               | 535.03               | Auto - Check         | NULL                 | monthly              | 5                    | 2019                 | -12.25               | -2.2383423476099984  | acceptable          
-- 3                    | 1                    | 1                    | 2019-07-05           | 839288.0             | 551.86               | 557.54               | Auto - Check         | NULL                 | monthly              | 6                    | 2019                 | 5.67999999999995     | 1.0292465480375368   | acceptable          
-- ...
-- 103                  | 2                    | 2                    | 2022-05-22           | NULL                 | NULL                 | 1452.09              | Auto - ACH           | NULL                 | monthly              | 4                    | 2022                 | NULL                 | NULL                 | unknown             
-- 104                  | 2                    | 2                    | 2022-06-17           | NULL                 | NULL                 | 1459.3               | Auto - ACH           | NULL                 | monthly              | 5                    | 2022                 | NULL                 | NULL                 | unknown             
-- 105                  | 2                    | 2                    | 2022-07-15           | NULL                 | NULL                 | 1361.45              | Auto - ACH           | NULL                 | monthly              | 6                    | 2022                 | NULL                 | NULL                 | unknown             
-- ...
-- 221                  | 5                    | 5                    | 2020-10-13           | NULL                 | 3750.0               | 3750.0               | Auto - Check         | NULL                 | quarterly            | 3                    | 2020                 | 0.0                  | 0.0                  | exact               
-- 222                  | 5                    | 5                    | 2021-01-14           | NULL                 | 3750.0               | 3750.0               | Auto - Check         | NULL                 | quarterly            | 4                    | 2020                 | 0.0                  | 0.0                  | exact               
-- 223                  | 5                    | 5                    | 2021-04-19           | NULL                 | 3000.0               | 3000.0               | Auto - Check         | NULL                 | quarterly            | 1                    | 2021                 | 0.0                  | 0.0                  | exact               
-- ...
-- 328                  | 9                    | 9                    | 2023-01-31           | NULL                 | 2500.0               | 2500.0               | Invoice - Check      | One check rcvd 1.31. | quarterly            | 4                    | 2022                 | 0.0                  | 0.0                  | exact               
-- 329                  | 9                    | 9                    | 2023-05-22           | NULL                 | 2500.0               | 2500.0               | Invoice - Check      | One check rcvd 5.22. | quarterly            | 1                    | 2023                 | 0.0                  | 0.0                  | exact               
-- 330                  | 9                    | 9                    | 2023-08-28           | NULL                 | 2500.0               | 2500.0               | Invoice - Check      | one check rcvd 8.28. | quarterly            | 2                    | 2023                 | 0.0                  | 0.0                  | exact               
-- ...
-- 428                  | 12                   | 12                   | 2021-04-19           | NULL                 | 2500.0               | 2250.0               | Auto - Check         | NULL                 | quarterly            | 1                    | 2021                 | -250.0               | -10.0                | warning             
-- 429                  | 12                   | 12                   | 2021-07-16           | NULL                 | 2250.0               | 2250.0               | Auto - Check         | NULL                 | quarterly            | 2                    | 2021                 | 0.0                  | 0.0                  | exact               
-- 430                  | 12                   | 12                   | 2021-10-18           | NULL                 | 2250.0               | 2250.0               | Auto - Check         | NULL                 | quarterly            | 3                    | 2021                 | 0.0                  | 0.0                  | exact               
-- ...
-- 528                  | 15                   | 15                   | 2022-11-15           | NULL                 | NULL                 | 65.36                | Auto - Check         | NULL                 | monthly              | 10                   | 2022                 | NULL                 | NULL                 | unknown             
-- 529                  | 15                   | 15                   | 2022-12-13           | 166997.0             | 69.637749            | 69.58                | Auto - Check         | NULL                 | monthly              | 11                   | 2022                 | -0.05774900000000116 | -0.08292772358279582 | acceptable          
-- 530                  | 15                   | 15                   | 2023-01-12           | 160289.0             | 66.840513            | 66.79                | Auto - Check         | NULL                 | monthly              | 12                   | 2022                 | -0.05051299999999514 | -0.07557243015174815 | acceptable          
-- ...
-- 636                  | 21                   | 21                   | 2021-09-14           | 115330.0             | 96.06989             | 95.66                | Auto - ACH           | NULL                 | monthly              | 8                    | 2021                 | -0.4098900000000043  | -0.4266581339897488  | acceptable          
-- 637                  | 21                   | 21                   | 2021-10-15           | 110904.0             | 92.383032            | 92.0                 | Auto - ACH           | NULL                 | monthly              | 9                    | 2021                 | -0.38303200000000004 | -0.41461293454841364 | acceptable          
-- 638                  | 21                   | 21                   | 2021-11-16           | 76777.0              | 63.955241            | 63.68                | Auto - ACH           | NULL                 | monthly              | 10                   | 2021                 | -0.2752410000000012  | -0.4303650423270255  | acceptable          
-- ...
-- 736                  | 23                   | 23                   | 2021-02-16           | 1076744.0            | 449.002248           | 447.55               | NULL                 | test
                | monthly              | 1                    | 2021                 | -1.4522479999999973  | -0.3234389151655199  | acceptable          
-- 737                  | 23                   | 23                   | 2021-03-15           | 1115961.0            | 465.355737           | 463.82               | NULL                 | NULL                 | monthly              | 2                    | 2021                 | -1.5357369999999833  | -0.33001355262113885 | acceptable          
-- 738                  | 23                   | 23                   | 2021-04-12           | 1154953.0            | 481.615401           | 480.17               | NULL                 | NULL                 | monthly              | 3                    | 2021                 | -1.445401000000004   | -0.3001151950288242  | acceptable          
-- ...
-- 846                  | 34                   | 28                   | 2021-08-23           | 2303295.0            | 1536.297765          | 1535.53              | Auto - ACH           | NULL                 | monthly              | 7                    | 2021                 | -0.767765000000054   | -0.04997501249375663 | acceptable          
-- 847                  | 34                   | 28                   | 2021-09-20           | 2321847.0            | 1548.671949          | 1547.92              | Auto - ACH           | NULL                 | monthly              | 8                    | 2021                 | -0.7519489999999678  | -0.04855444049887467 | acceptable          
-- 848                  | 34                   | 28                   | 2021-10-20           | 2340138.0            | 1560.872046          | 1560.11              | Auto - ACH           | NULL                 | monthly              | 9                    | 2021                 | -0.7620460000000548  | -0.04882181098398983 | acceptable          

-- === View: quarterly_summaries === --
-- Schema: dbo
-- Row Count: 221

-- Create quarterly view to replace the table
CREATE VIEW [dbo].[quarterly_summaries_view] AS
SELECT 
    client_id,
    applied_year as [year],
    applied_period as [quarter],
    SUM(actual_fee) as total_payments,
    AVG(total_assets) as total_assets,
    COUNT(*) as payment_count,
    AVG(actual_fee) as avg_payment,
    SUM(expected_fee) as expected_total,
    MAX(received_date) as last_updated
FROM payments 
WHERE applied_period_type = 'quarterly'
GROUP BY client_id, applied_year, applied_period;

** -- SAMPLE DATA -- **
-- client_id            | year                 | quarter              | total_payments       | total_assets         | payment_count        | avg_payment          | expected_total       | last_updated        
-- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 4                    | 2023                 | 1                    | 8055.94              | NULL                 | 1                    | 8055.94              | NULL                 | 2023-06-09          
-- 4                    | 2023                 | 2                    | 8979.97              | NULL                 | 1                    | 8979.97              | NULL                 | 2023-07-24          
-- 4                    | 2023                 | 3                    | 9621.19              | NULL                 | 1                    | 9621.19              | NULL                 | 2023-10-23          
-- ...
-- 14                   | 2019                 | 3                    | 3750.0               | NULL                 | 1                    | 3750.0               | 3750.0               | 2019-10-08          
-- 14                   | 2019                 | 4                    | 3750.0               | NULL                 | 1                    | 3750.0               | 3750.0               | 2020-01-13          
-- 14                   | 2020                 | 1                    | 3750.0               | NULL                 | 1                    | 3750.0               | 3750.0               | 2020-04-13          
-- ...
-- 19                   | 2024                 | 3                    | 2000.0               | NULL                 | 1                    | 2000.0               | 2000.0               | 2024-10-16          
-- 20                   | 2019                 | 4                    | 4000.0               | NULL                 | 1                    | 4000.0               | 6250.0               | 2020-02-13          
-- 20                   | 2020                 | 1                    | 8000.0               | NULL                 | 1                    | 8000.0               | 6250.0               | 2020-05-07          

-- === View: yearly_summaries === --
-- Schema: dbo
-- Row Count: 149

-- Create yearly view to replace the table
CREATE VIEW [dbo].[yearly_summaries_view] AS
WITH yearly_data AS (
    SELECT 
        client_id,
        applied_year as [year],
        SUM(actual_fee) as total_payments,
        AVG(total_assets) as total_assets,
        COUNT(*) as payment_count,
        AVG(actual_fee) as avg_payment
    FROM payments 
    GROUP BY client_id, applied_year
)
SELECT 
    y1.*,
    CASE 
        WHEN y2.total_payments > 0 
        THEN ((y1.total_payments - y2.total_payments) / y2.total_payments * 100) 
        ELSE NULL 
    END as yoy_growth,
    GETDATE() as last_updated
FROM yearly_data y1
LEFT JOIN yearly_data y2 ON y1.client_id = y2.client_id 
    AND y1.[year] = y2.[year] + 1;

** -- SAMPLE DATA -- **
-- client_id            | year                 | total_payments       | total_assets         | payment_count        | avg_payment          | yoy_growth           | last_updated        
-- -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1                    | 2019                 | 5097.049999999999    | 844498.5             | 9                    | 566.3388888888888    | NULL                 | 2025-07-08 05:07:51.
-- 1                    | 2020                 | 7436.03              | 943264.8181818182    | 12                   | 619.6691666666667    | 45.888896518574484   | 2025-07-08 05:07:51.
-- 1                    | 2021                 | 9255.880000000001    | 1161233.9166666667   | 12                   | 771.3233333333334    | 24.473408525785956   | 2025-07-08 05:07:51.
-- ...
-- 14                   | 2024                 | 11250.0              | NULL                 | 3                    | 3750.0               | -24.999849999699997  | 2025-07-08 05:07:51.
-- 15                   | 2019                 | 683.01               | 182221.2857142857    | 8                    | 85.37625             | NULL                 | 2025-07-08 05:07:51.
-- 15                   | 2020                 | 2503.43              | 474736.1666666667    | 12                   | 208.61916666666664   | 266.5290405704162    | 2025-07-08 05:07:51.

-- === INDEXES === --

-- Table: dbo.contacts
--   idx_contacts_client_id: NONCLUSTERED (client_id)
--   idx_contacts_type: NONCLUSTERED (client_id, contact_type)
-- Table: dbo.contracts
--   idx_contracts_client_id: NONCLUSTERED (client_id)
--   idx_contracts_provider: NONCLUSTERED (provider_name)
-- Table: dbo.payment_periods
--   idx_payment_periods_dates: NONCLUSTERED (period_type, start_date, end_date)
-- Table: dbo.payments
--   idx_payments_client_id: NONCLUSTERED (client_id)
--   idx_payments_contract_id: NONCLUSTERED (contract_id)
--   idx_payments_date: NONCLUSTERED (client_id, received_date)
--   idx_payments_period_lookup: NONCLUSTERED (client_id, applied_year, applied_period)
--   UQ_payment_period: NONCLUSTERED UNIQUE (client_id, applied_year, applied_period, applied_period_type)
